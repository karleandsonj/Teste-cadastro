<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CadastroSheet</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f0e8;
    --surface: #fffef9;
    --surface2: #eee8d8;
    --border: #d4c9b0;
    --accent: #c0392b;
    --accent2: #e74c3c;
    --accent3: #27ae60;
    --ink: #1a1208;
    --muted: #8a7a5a;
    --shadow: rgba(26,18,8,0.12);
    --blue: #2980b9;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--ink);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 27px, rgba(180,160,120,0.15) 28px),
      repeating-linear-gradient(90deg, transparent, transparent 27px, rgba(180,160,120,0.08) 28px);
  }
  header {
    background: var(--ink);
    color: var(--bg);
    padding: 1.2rem 3rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    box-shadow: 0 4px 20px var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.5rem;
    letter-spacing: -0.03em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .logo-dot {
    width: 10px; height: 10px;
    background: var(--accent2);
    border-radius: 50%;
    display: inline-block;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }
  .header-tag {
    font-size: 0.65rem;
    color: rgba(245,240,232,0.4);
    margin-left: auto;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 3rem 2rem;
  }
  .stats-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .stat {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.8rem 1rem;
    text-align: center;
  }
  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--ink);
    line-height: 1;
  }
  .stat-label {
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-top: 0.3rem;
  }
  .grid {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 2rem;
    align-items: start;
  }
  @media (max-width: 820px) {
    .grid { grid-template-columns: 1fr; }
    header { padding: 1rem 1.5rem; }
    .container { padding: 2rem 1rem; }
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px var(--shadow);
    animation: fadeUp 0.5s ease both;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .card-header {
    background: var(--ink);
    color: var(--bg);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .card-body { padding: 1.5rem; }
  .form-group { margin-bottom: 1.2rem; }
  label {
    display: block;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 0.4rem;
    font-weight: 500;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 0.7rem 1rem;
    color: var(--ink);
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    outline: none;
    transition: all 0.2s;
  }
  input[type="text"]:focus, input[type="number"]:focus {
    border-color: var(--accent);
    background: var(--surface);
    box-shadow: 0 0 0 3px rgba(192,57,43,0.1);
  }
  input::placeholder { color: var(--muted); opacity: 0.5; }
  .id-preview {
    background: var(--surface2);
    border: 1.5px dashed var(--border);
    border-radius: 8px;
    padding: 0.7rem 1rem;
    font-size: 0.85rem;
    color: var(--muted);
    font-style: italic;
  }

  /* ======= FILE UPLOAD ======= */
  .file-drop-zone {
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 1.2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s;
    background: var(--surface2);
    position: relative;
  }
  .file-drop-zone:hover, .file-drop-zone.drag-over {
    border-color: var(--accent);
    background: rgba(192,57,43,0.04);
    box-shadow: 0 0 0 3px rgba(192,57,43,0.08);
  }
  .file-drop-zone input[type="file"] {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }
  .file-drop-icon { font-size: 1.6rem; margin-bottom: 0.3rem; opacity: 0.5; }
  .file-drop-text { font-size: 0.72rem; color: var(--muted); line-height: 1.5; }
  .file-drop-text strong { color: var(--ink); }

  /* File Previews Grid */
  .attachments-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.6rem;
    margin-top: 0.8rem;
  }
  .attach-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 1.5px solid var(--border);
    background: var(--surface2);
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    cursor: pointer;
    transition: all 0.2s;
    animation: fadeUp 0.3s ease both;
  }
  .attach-item:hover { border-color: var(--accent); transform: scale(1.03); }
  .attach-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .attach-item .file-icon { font-size: 1.6rem; }
  .attach-item .file-name {
    font-size: 0.55rem;
    color: var(--muted);
    text-align: center;
    padding: 0 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    width: 100%;
    padding-bottom: 4px;
  }
  .attach-remove {
    position: absolute;
    top: 3px; right: 3px;
    width: 18px; height: 18px;
    background: var(--accent2);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 0.6rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 2;
  }
  .attach-item:hover .attach-remove { opacity: 1; }
  .attach-size-label {
    position: absolute;
    bottom: 22px;
    right: 3px;
    background: rgba(0,0,0,0.55);
    color: white;
    font-size: 0.5rem;
    padding: 1px 4px;
    border-radius: 3px;
  }

  .btn {
    width: 100%;
    padding: 0.85rem;
    border: none;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  .btn-primary { background: var(--ink); color: var(--bg); }
  .btn-primary:hover {
    background: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(192,57,43,0.3);
  }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .search-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
  .search-bar input { flex: 1; }
  .btn-search {
    background: var(--ink);
    color: var(--bg);
    border: none;
    border-radius: 8px;
    padding: 0.7rem 1rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-search:hover { background: var(--accent); }

  /* TABLE */
  .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  thead { background: var(--surface2); }
  th {
    padding: 0.8rem 1rem;
    text-align: left;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    font-weight: 500;
  }
  td {
    padding: 0.7rem 1rem;
    border-bottom: 1px solid rgba(212,201,176,0.5);
    transition: background 0.15s;
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }
  .id-badge {
    background: var(--ink);
    color: var(--bg);
    border-radius: 4px;
    padding: 0.15rem 0.5rem;
    font-size: 0.7rem;
    font-weight: 600;
    display: inline-block;
  }
  .age-chip {
    background: rgba(39,174,96,0.12);
    color: var(--accent3);
    border: 1px solid rgba(39,174,96,0.3);
    border-radius: 20px;
    padding: 0.15rem 0.6rem;
    font-size: 0.72rem;
    display: inline-block;
  }

  /* Thumbnail in table */
  .thumb-row {
    display: flex;
    gap: 4px;
    align-items: center;
    flex-wrap: wrap;
  }
  .thumb-mini {
    width: 30px; height: 30px;
    border-radius: 4px;
    object-fit: cover;
    border: 1.5px solid var(--border);
    cursor: pointer;
    transition: transform 0.2s;
  }
  .thumb-mini:hover { transform: scale(1.15); }
  .file-chip {
    background: rgba(41,128,185,0.1);
    color: var(--blue);
    border: 1px solid rgba(41,128,185,0.25);
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.62rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .file-chip:hover { background: var(--blue); color: white; }
  .no-attach { color: var(--muted); opacity: 0.4; font-size: 0.72rem; }

  /* ACTION BUTTONS */
  .actions { display: flex; gap: 0.4rem; }
  .btn-icon {
    border: none;
    border-radius: 6px;
    width: 30px; height: 30px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .btn-edit {
    background: rgba(39,174,96,0.12);
    color: var(--accent3);
    border: 1px solid rgba(39,174,96,0.25);
  }
  .btn-edit:hover { background: var(--accent3); color: white; transform: scale(1.1); }
  .btn-delete {
    background: rgba(231,76,60,0.1);
    color: var(--accent2);
    border: 1px solid rgba(231,76,60,0.25);
  }
  .btn-delete:hover { background: var(--accent2); color: white; transform: scale(1.1); }

  /* EMPTY / LOADING */
  .empty-state { text-align: center; padding: 3rem 1rem; color: var(--muted); }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.4; }
  .empty-state p { font-size: 0.8rem; }
  .loading {
    display: flex; align-items: center; justify-content: center;
    gap: 0.5rem; padding: 2rem; color: var(--muted); font-size: 0.8rem;
  }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(26,18,8,0.6);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 100%;
    max-width: 480px;
    margin: 1rem;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalUp 0.25s ease;
    overflow: hidden;
    max-height: 90vh;
    overflow-y: auto;
  }
  @keyframes modalUp {
    from { opacity: 0; transform: translateY(20px) scale(0.97); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  .modal-header {
    background: var(--ink);
    color: var(--bg);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky; top: 0; z-index: 5;
  }
  .modal-close {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--bg);
    border-radius: 6px;
    width: 28px; height: 28px;
    cursor: pointer;
    font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  .modal-close:hover { background: var(--accent2); }
  .modal-body { padding: 1.5rem; }
  .modal-footer { padding: 0 1.5rem 1.5rem; display: flex; gap: 0.7rem; }
  .btn-cancel {
    flex: 1; padding: 0.75rem; border: 1.5px solid var(--border);
    border-radius: 8px; background: transparent; color: var(--muted);
    font-family: 'DM Mono', monospace; font-size: 0.82rem; cursor: pointer;
    transition: all 0.2s;
  }
  .btn-cancel:hover { border-color: var(--ink); color: var(--ink); }
  .btn-save {
    flex: 2; padding: 0.75rem; border: none;
    border-radius: 8px; background: var(--accent3); color: white;
    font-family: 'DM Mono', monospace; font-size: 0.82rem; cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.4rem;
  }
  .btn-save:hover { background: #219a52; transform: translateY(-1px); }
  .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* LIGHTBOX */
  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 999;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
  }
  .lightbox.active { display: flex; animation: fadeIn 0.2s ease; }
  .lightbox-inner {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .lightbox-inner img {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 8px;
    object-fit: contain;
    box-shadow: 0 0 60px rgba(0,0,0,0.5);
  }
  .lightbox-caption {
    color: rgba(255,255,255,0.6);
    font-size: 0.75rem;
    margin-top: 1rem;
    text-align: center;
  }
  .lightbox-close {
    position: absolute;
    top: -40px; right: 0;
    background: rgba(255,255,255,0.15);
    border: none;
    color: white;
    width: 32px; height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  .lightbox-close:hover { background: var(--accent2); }
  .lightbox-pdf {
    width: 80vw;
    height: 80vh;
    border-radius: 8px;
    border: none;
  }
  .pdf-placeholder {
    background: var(--surface);
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    min-width: 320px;
  }
  .pdf-placeholder .icon { font-size: 3rem; margin-bottom: 1rem; }
  .pdf-placeholder p { font-size: 0.8rem; color: var(--muted); margin-bottom: 1rem; }
  .pdf-placeholder a {
    background: var(--accent);
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.8rem;
    display: inline-block;
    transition: background 0.2s;
  }
  .pdf-placeholder a:hover { background: var(--ink); }

  /* CONFIRM DELETE */
  .confirm-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(26,18,8,0.6);
    backdrop-filter: blur(4px);
    z-index: 300;
    align-items: center;
    justify-content: center;
  }
  .confirm-overlay.active { display: flex; animation: fadeIn 0.2s ease; }
  .confirm-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 100%;
    max-width: 340px;
    margin: 1rem;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalUp 0.25s ease;
  }
  .confirm-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
  .confirm-title {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
  }
  .confirm-msg { font-size: 0.78rem; color: var(--muted); margin-bottom: 1.5rem; line-height: 1.6; }
  .confirm-btns { display: flex; gap: 0.7rem; }
  .btn-confirm-cancel {
    flex: 1; padding: 0.75rem; border: 1.5px solid var(--border);
    border-radius: 8px; background: transparent; color: var(--muted);
    font-family: 'DM Mono', monospace; font-size: 0.82rem; cursor: pointer;
    transition: all 0.2s;
  }
  .btn-confirm-cancel:hover { border-color: var(--ink); color: var(--ink); }
  .btn-confirm-delete {
    flex: 1; padding: 0.75rem; border: none;
    border-radius: 8px; background: var(--accent2); color: white;
    font-family: 'DM Mono', monospace; font-size: 0.82rem; cursor: pointer;
    transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.4rem;
  }
  .btn-confirm-delete:hover { background: var(--accent); }
  .btn-confirm-delete:disabled { opacity: 0.5; cursor: not-allowed; }

  /* TOAST */
  .toast-container {
    position: fixed; bottom: 2rem; right: 2rem;
    display: flex; flex-direction: column; gap: 0.5rem; z-index: 999;
  }
  .toast {
    background: var(--ink); color: var(--bg);
    padding: 0.8rem 1.2rem; border-radius: 8px;
    font-size: 0.78rem; display: flex; align-items: center; gap: 0.6rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: toastIn 0.3s ease; max-width: 300px;
  }
  .toast.success { border-left: 3px solid var(--accent3); }
  .toast.error { border-left: 3px solid var(--accent2); }
  @keyframes toastIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* Upload progress */
  .upload-progress {
    height: 3px;
    background: var(--surface2);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
    display: none;
  }
  .upload-progress-bar {
    height: 100%;
    background: var(--accent3);
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0%;
  }

  /* APPS SCRIPT BANNER */
  .script-banner {
    background: var(--ink);
    color: var(--bg);
    border-radius: 12px;
    margin-bottom: 2rem;
    overflow: hidden;
  }
  .script-banner-header {
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
  }
  .script-banner-header span {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.8rem;
    color: #f39c12;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .script-banner-toggle {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--bg);
    border-radius: 6px;
    padding: 0.3rem 0.7rem;
    cursor: pointer;
    font-size: 0.7rem;
    font-family: 'DM Mono', monospace;
    transition: background 0.2s;
  }
  .script-banner-toggle:hover { background: rgba(255,255,255,0.2); }
  .script-banner-body {
    padding: 0 1.5rem 1.5rem;
    font-size: 0.75rem;
    color: rgba(245,240,232,0.85);
    line-height: 1.6;
  }
  .code-block {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 0.8rem;
    font-size: 0.68rem;
    color: #a8e6cf;
    overflow-x: auto;
    white-space: pre;
    line-height: 1.6;
  }

  .attach-count-badge {
    background: rgba(41,128,185,0.15);
    color: var(--blue);
    border: 1px solid rgba(41,128,185,0.3);
    border-radius: 12px;
    padding: 0.1rem 0.5rem;
    font-size: 0.65rem;
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
  }

  .section-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.2rem 0;
  }

  .file-type-icon { font-size: 1.4rem; }

  /* Current attachments in edit modal */
  .current-attach-list { display: flex; flex-direction: column; gap: 6px; }
  .current-attach-item {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 0.72rem;
  }
  .current-attach-item .thumb-sm {
    width: 36px; height: 36px;
    border-radius: 4px;
    object-fit: cover;
    border: 1px solid var(--border);
    flex-shrink: 0;
    cursor: pointer;
  }
  .current-attach-item .name { flex: 1; color: var(--ink); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .current-attach-item .size { color: var(--muted); flex-shrink: 0; }
  .btn-detach {
    background: rgba(231,76,60,0.1);
    border: 1px solid rgba(231,76,60,0.2);
    color: var(--accent2);
    border-radius: 4px;
    width: 22px; height: 22px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 0.65rem;
    transition: all 0.2s; flex-shrink: 0;
  }
  .btn-detach:hover { background: var(--accent2); color: white; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-dot"></span>
    CadastroSheet
  </div>
  <span class="header-tag">Google Sheets ¬∑ Drive Attachments</span>
</header>

<div class="container">

  <!-- COLLAPSIBLE APPS SCRIPT BANNER -->
  <div class="script-banner" id="scriptBanner">
    <div class="script-banner-header" onclick="toggleBanner()">
      <span>‚öô C√≥digo Apps Script ‚Äî com suporte a anexos via Drive</span>
      <button class="script-banner-toggle" id="bannerToggleBtn">‚ñº ver c√≥digo</button>
    </div>
    <div class="script-banner-body" id="bannerBody" style="display:none">
      <p>Substitua o c√≥digo do Apps Script por este (suporte a criar, editar, excluir e <strong>upload de anexos no Google Drive</strong>):</p>
      <div class="code-block">const SHEET_ID = "SEU_SHEET_ID_AQUI";
const FOLDER_ID = "SEU_FOLDER_ID_AQUI"; // Pasta no Drive para os anexos

function doGet(e) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1).map((row, i) => {
    let obj = { _row: i + 2 };
    headers.forEach((h, j) => obj[h] = row[j]);
    return obj;
  });
  const q = (e.parameter.q || "").toLowerCase();
  const filtered = q ? rows.filter(r =>
    String(r.ID).toLowerCase().includes(q) ||
    String(r.Nome).toLowerCase().includes(q) ||
    String(r.Idade).toLowerCase().includes(q)
  ) : rows;
  return ContentService
    .createTextOutput(JSON.stringify({ ok: true, data: filtered }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
  const body = JSON.parse(e.postData.contents);
  const action = body.action;

  if (action === "create") {
    const nextId = sheet.getLastRow();
    const attachJson = body.attachments ? JSON.stringify(body.attachments) : "";
    sheet.appendRow([nextId, body.nome, body.idade, attachJson]);
    return ok({ id: nextId });
  }

  if (action === "update") {
    const row = Number(body._row);
    sheet.getRange(row, 2).setValue(body.nome);
    sheet.getRange(row, 3).setValue(body.idade);
    if (body.attachments !== undefined) {
      sheet.getRange(row, 4).setValue(JSON.stringify(body.attachments));
    }
    return ok({ updated: true });
  }

  if (action === "delete") {
    sheet.deleteRow(Number(body._row));
    return ok({ deleted: true });
  }

  if (action === "upload") {
    // body.file: { name, mimeType, data (base64) }
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const blob = Utilities.newBlob(
      Utilities.base64Decode(body.file.data),
      body.file.mimeType,
      body.file.name
    );
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return ok({
      fileId: file.getId(),
      fileName: file.getName(),
      mimeType: file.getMimeType(),
      url: "https://drive.google.com/uc?id=" + file.getId() + "&export=download",
      viewUrl: "https://drive.google.com/file/d/" + file.getId() + "/view",
      thumbUrl: file.getMimeType().startsWith("image/")
        ? "https://drive.google.com/thumbnail?id=" + file.getId() + "&sz=w200"
        : null
    });
  }

  return ok({ error: "a√ß√£o desconhecida" });
}

function ok(data) {
  return ContentService
    .createTextOutput(JSON.stringify({ ok: true, ...data }))
    .setMimeType(ContentService.MimeType.JSON);
}</div>
      <p style="margin-top:0.8rem; font-size:0.72rem; color:rgba(245,240,232,0.5)">Ap√≥s colar: Implantar ‚Üí Gerenciar implanta√ß√µes ‚Üí ‚úè Editar ‚Üí Nova vers√£o ‚Üí Implantar. Certifique-se que a permiss√£o de acesso √© "Qualquer pessoa".</p>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-row" id="statsRow" style="display:none">
    <div class="stat">
      <div class="stat-value" id="statTotal">0</div>
      <div class="stat-label">Total Registros</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="statAvgAge">‚Äî</div>
      <div class="stat-label">M√©dia de Idade</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="statLast">‚Äî</div>
      <div class="stat-label">√öltimo ID</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="statAttach">0</div>
      <div class="stat-label">Total Anexos</div>
    </div>
  </div>

  <div class="grid">

    <!-- CADASTRO -->
    <div class="card">
      <div class="card-header">‚ú¶ Cadastrar Registro</div>
      <div class="card-body">
        <div class="form-group">
          <label>ID (autom√°tico)</label>
          <div class="id-preview" id="nextIdPreview">Gerado automaticamente</div>
        </div>
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" id="inputNome" placeholder="Ex: Maria Silva" autocomplete="off" />
        </div>
        <div class="form-group">
          <label>Idade *</label>
          <input type="number" id="inputIdade" placeholder="Ex: 28" min="0" max="150" />
        </div>

        <hr class="section-divider">

        <!-- UPLOAD ZONE -->
        <div class="form-group">
          <label>üìé Anexos (imagens, PDF, docs)</label>
          <div class="file-drop-zone" id="dropZone"
               ondragover="handleDragOver(event,'dropZone')"
               ondragleave="handleDragLeave('dropZone')"
               ondrop="handleDrop(event,'new')">
            <input type="file" id="inputFile" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                   onchange="handleFileSelect(this.files,'new')" />
            <div class="file-drop-icon">üìÇ</div>
            <div class="file-drop-text">
              <strong>Clique ou arraste arquivos aqui</strong><br>
              Imagens, PDF, Word, Excel ¬∑ M√°x 10MB/arquivo
            </div>
          </div>
          <div class="upload-progress" id="uploadProgress">
            <div class="upload-progress-bar" id="uploadProgressBar"></div>
          </div>
          <div class="attachments-preview" id="newAttachPreview"></div>
        </div>

        <button class="btn btn-primary" id="btnCadastrar" onclick="cadastrar()">
          ‚Üë Salvar na Planilha
        </button>
      </div>
    </div>

    <!-- LISTA -->
    <div class="card">
      <div class="card-header">
        ‚óé Registros
        <button onclick="loadData()" style="margin-left:auto;background:rgba(255,255,255,0.1);border:none;color:inherit;padding:0.3rem 0.7rem;border-radius:4px;cursor:pointer;font-size:0.7rem;font-family:'DM Mono',monospace">‚Üª Atualizar</button>
      </div>
      <div class="card-body">
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Buscar por ID, nome ou idade..." oninput="searchData(this.value)" />
          <button class="btn-search" onclick="searchData(document.getElementById('searchInput').value)">Buscar</button>
        </div>
        <div id="tableArea">
          <div class="loading"><div class="spinner"></div> Carregando...</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      ‚úé Editar Registro
      <button class="modal-close" onclick="closeEdit()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editRow" />
      <input type="hidden" id="editId" />
      <div class="form-group">
        <label>ID</label>
        <div class="id-preview" id="editIdPreview">‚Äî</div>
      </div>
      <div class="form-group">
        <label>Nome *</label>
        <input type="text" id="editNome" placeholder="Nome" autocomplete="off" />
      </div>
      <div class="form-group">
        <label>Idade *</label>
        <input type="number" id="editIdade" placeholder="Idade" min="0" max="150" />
      </div>

      <hr class="section-divider">

      <!-- Current attachments -->
      <div class="form-group" id="currentAttachGroup" style="display:none">
        <label>üìé Anexos atuais</label>
        <div class="current-attach-list" id="currentAttachList"></div>
      </div>

      <!-- Add new attachments in edit -->
      <div class="form-group" style="margin-bottom:0">
        <label>‚ûï Adicionar novos anexos</label>
        <div class="file-drop-zone" id="editDropZone"
             ondragover="handleDragOver(event,'editDropZone')"
             ondragleave="handleDragLeave('editDropZone')"
             ondrop="handleDrop(event,'edit')">
          <input type="file" id="editInputFile" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                 onchange="handleFileSelect(this.files,'edit')" />
          <div class="file-drop-icon">üìÇ</div>
          <div class="file-drop-text">
            <strong>Clique ou arraste</strong> para adicionar mais arquivos
          </div>
        </div>
        <div class="upload-progress" id="editUploadProgress">
          <div class="upload-progress-bar" id="editUploadProgressBar"></div>
        </div>
        <div class="attachments-preview" id="editAttachPreview"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeEdit()">Cancelar</button>
      <button class="btn-save" id="btnSaveEdit" onclick="saveEdit()">‚úì Salvar Altera√ß√µes</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="confirm-overlay" id="confirmModal">
  <div class="confirm-box">
    <div class="confirm-icon">üóë</div>
    <div class="confirm-title">Excluir registro?</div>
    <div class="confirm-msg" id="confirmMsg">Esta a√ß√£o n√£o pode ser desfeita.</div>
    <div class="confirm-btns">
      <button class="btn-confirm-cancel" onclick="closeConfirm()">Cancelar</button>
      <button class="btn-confirm-delete" id="btnConfirmDelete" onclick="confirmDelete()">‚úï Excluir</button>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
  <div class="lightbox-inner" id="lightboxInner">
    <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
    <div id="lightboxContent"></div>
    <div class="lightbox-caption" id="lightboxCaption"></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
  // Auto-detect URL: works both standalone and hosted on Apps Script
  const API_URL = (() => {
    const url = window.location.href;
    // If hosted on Apps Script (script.google.com), use current URL
    if (url.includes('script.google.com') || url.includes('googleusercontent.com')) {
      return url.split('?')[0];
    }
    // Fallback: your deployed Apps Script URL
    return 'https://script.google.com/macros/s/AKfycbxVHwMntjBGYjEfKWaUJzIzuS6gAlKWzQ0rbROGYzf-48KpNFgapIK4Nrogq2D2b_qF/exec';
  })();

  let allData = [];
  let searchTimeout;
  let pendingDeleteRow = null;

  // Attachment stores: array of { file, name, size, type, dataUrl, uploaded, result }
  let newAttachments = [];
  let editAttachments = []; // new ones to upload
  let editCurrentAttachments = []; // existing ones from DB (array of {fileId,fileName,url,thumbUrl,mimeType})

  loadData();

  // ===== BANNER TOGGLE =====
  function toggleBanner() {
    const body = document.getElementById('bannerBody');
    const btn = document.getElementById('bannerToggleBtn');
    const open = body.style.display === 'none';
    body.style.display = open ? 'block' : 'none';
    btn.textContent = open ? '‚ñ≤ fechar' : '‚ñº ver c√≥digo';
  }

  // ===== LOAD =====
  async function loadData() {
    showLoading();
    try {
      const res = await fetch(API_URL + '?action=read', {
        redirect: 'follow', credentials: 'omit'
      });
      const json = await res.json();
      if (json.ok) {
        allData = json.data || [];
        renderTable(allData);
        updateStats(allData);
        updateNextId(allData);
      } else throw new Error();
    } catch (err) {
      showError('Erro ao carregar. Verifique as permiss√µes da implanta√ß√£o (Qualquer pessoa) e reimplante com nova vers√£o.');
    }
  }

  // ===== SEARCH =====
  function searchData(q) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (!q.trim()) { renderTable(allData); return; }
      const lower = q.toLowerCase();
      const filtered = allData.filter(r =>
        String(r.ID ?? '').toLowerCase().includes(lower) ||
        String(r.Nome ?? '').toLowerCase().includes(lower) ||
        String(r.Idade ?? '').toLowerCase().includes(lower)
      );
      renderTable(filtered);
    }, 300);
  }

  // ===== FILE HANDLING =====
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

  function getFileIcon(type) {
    if (!type) return 'üìÑ';
    if (type.startsWith('image/')) return 'üñº';
    if (type === 'application/pdf') return 'üìï';
    if (type.includes('word') || type.includes('document')) return 'üìò';
    if (type.includes('excel') || type.includes('spreadsheet') || type.includes('csv')) return 'üìó';
    if (type.includes('text')) return 'üìÑ';
    return 'üìé';
  }

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function handleDragOver(e, zoneId) {
    e.preventDefault();
    document.getElementById(zoneId).classList.add('drag-over');
  }
  function handleDragLeave(zoneId) {
    document.getElementById(zoneId).classList.remove('drag-over');
  }
  function handleDrop(e, context) {
    e.preventDefault();
    const zoneId = context === 'new' ? 'dropZone' : 'editDropZone';
    document.getElementById(zoneId).classList.remove('drag-over');
    handleFileSelect(e.dataTransfer.files, context);
  }

  function handleFileSelect(files, context) {
    const arr = context === 'new' ? newAttachments : editAttachments;
    const previewId = context === 'new' ? 'newAttachPreview' : 'editAttachPreview';

    for (const file of files) {
      if (file.size > MAX_FILE_SIZE) {
        toast(`‚ö† ${file.name} √© muito grande (m√°x 10MB)`, 'error');
        continue;
      }
      const entry = { file, name: file.name, size: file.size, type: file.type, dataUrl: null, uploaded: false, result: null };
      arr.push(entry);

      // Generate preview
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          entry.dataUrl = ev.target.result;
          renderAttachPreviews(context);
        };
        reader.readAsDataURL(file);
      } else {
        renderAttachPreviews(context);
      }
    }
    renderAttachPreviews(context);
  }

  function renderAttachPreviews(context) {
    const arr = context === 'new' ? newAttachments : editAttachments;
    const previewEl = document.getElementById(context === 'new' ? 'newAttachPreview' : 'editAttachPreview');
    previewEl.innerHTML = '';

    arr.forEach((entry, idx) => {
      const item = document.createElement('div');
      item.className = 'attach-item';

      if (entry.dataUrl) {
        const img = document.createElement('img');
        img.src = entry.dataUrl;
        img.onclick = () => openLightboxLocal(entry.dataUrl, entry.name);
        item.appendChild(img);
      } else {
        const icon = document.createElement('div');
        icon.className = 'file-type-icon';
        icon.textContent = getFileIcon(entry.type);
        item.appendChild(icon);
        const name = document.createElement('div');
        name.className = 'file-name';
        name.textContent = entry.name;
        item.appendChild(name);
      }

      const sizeLabel = document.createElement('div');
      sizeLabel.className = 'attach-size-label';
      sizeLabel.textContent = formatBytes(entry.size);
      item.appendChild(sizeLabel);

      if (entry.uploaded) {
        const check = document.createElement('div');
        check.style.cssText = 'position:absolute;top:3px;left:3px;background:#27ae60;color:white;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.55rem;';
        check.textContent = '‚úì';
        item.appendChild(check);
      }

      const removeBtn = document.createElement('button');
      removeBtn.className = 'attach-remove';
      removeBtn.textContent = '‚úï';
      removeBtn.onclick = (e) => {
        e.stopPropagation();
        arr.splice(idx, 1);
        renderAttachPreviews(context);
      };
      item.appendChild(removeBtn);
      previewEl.appendChild(item);
    });
  }

  // Upload files to Apps Script (converts to base64)
  async function uploadFiles(arr, context) {
    const progressEl = document.getElementById(context === 'new' ? 'uploadProgress' : 'editUploadProgress');
    const barEl = document.getElementById(context === 'new' ? 'uploadProgressBar' : 'editUploadProgressBar');
    const toUpload = arr.filter(e => !e.uploaded);
    if (!toUpload.length) return;

    progressEl.style.display = 'block';
    let done = 0;

    for (const entry of toUpload) {
      try {
        const base64 = await fileToBase64(entry.file);
        const res = await fetch(API_URL, {
          method: 'POST', redirect: 'follow', credentials: 'omit',
          body: JSON.stringify({
            action: 'upload',
            file: { name: entry.name, mimeType: entry.type || 'application/octet-stream', data: base64 }
          })
        });
        const json = await res.json();
        if (json.ok) {
          entry.uploaded = true;
          entry.result = {
            fileId: json.fileId,
            fileName: json.fileName,
            mimeType: json.mimeType,
            url: json.url,
            viewUrl: json.viewUrl,
            thumbUrl: json.thumbUrl
          };
        }
      } catch (err) {
        toast(`Erro ao enviar ${entry.name}`, 'error');
      }
      done++;
      barEl.style.width = Math.round((done / toUpload.length) * 100) + '%';
      renderAttachPreviews(context);
    }

    setTimeout(() => {
      progressEl.style.display = 'none';
      barEl.style.width = '0%';
    }, 800);
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function getUploadedAttachments(arr) {
    return arr.filter(e => e.uploaded && e.result).map(e => e.result);
  }

  // ===== CADASTRAR =====
  async function cadastrar() {
    const nome = document.getElementById('inputNome').value.trim();
    const idade = document.getElementById('inputIdade').value.trim();
    if (!nome) { toast('Preencha o Nome!', 'error'); return; }
    if (!idade || isNaN(idade) || +idade < 0 || +idade > 150) { toast('Informe uma idade v√°lida!', 'error'); return; }

    const btn = document.getElementById('btnCadastrar');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Enviando anexos...';

    try {
      // First upload files
      if (newAttachments.length > 0) {
        await uploadFiles(newAttachments, 'new');
      }

      btn.innerHTML = '<span class="spinner"></span> Salvando...';

      const attachments = getUploadedAttachments(newAttachments);

      const res = await fetch(API_URL, {
        method: 'POST', redirect: 'follow', credentials: 'omit',
        body: JSON.stringify({ action: 'create', nome, idade: Number(idade), attachments })
      });
      const json = await res.json();
      if (json.ok) {
        const anexoTxt = attachments.length ? ` + ${attachments.length} anexo(s)` : '';
        toast(`‚úì Registro #${json.id} cadastrado!${anexoTxt}`, 'success');
        document.getElementById('inputNome').value = '';
        document.getElementById('inputIdade').value = '';
        newAttachments = [];
        document.getElementById('newAttachPreview').innerHTML = '';
        document.getElementById('inputNome').focus();
        await loadData();
      } else throw new Error();
    } catch { toast('Erro ao salvar. Tente novamente.', 'error'); }
    finally {
      btn.disabled = false;
      btn.innerHTML = '‚Üë Salvar na Planilha';
    }
  }

  // ===== EDIT =====
  function openEdit(row) {
    const r = allData.find(x => x._row == row);
    if (!r) return;
    document.getElementById('editRow').value = r._row;
    document.getElementById('editId').value = r.ID;
    document.getElementById('editIdPreview').textContent = '#' + r.ID;
    document.getElementById('editNome').value = r.Nome ?? '';
    document.getElementById('editIdade').value = r.Idade ?? '';

    editAttachments = [];
    document.getElementById('editAttachPreview').innerHTML = '';

    // Parse current attachments
    try {
      const raw = r.Anexos || r.attachments || '';
      editCurrentAttachments = raw ? JSON.parse(raw) : [];
    } catch { editCurrentAttachments = []; }

    renderCurrentAttachments();
    document.getElementById('editModal').classList.add('active');
    setTimeout(() => document.getElementById('editNome').focus(), 100);
  }

  function renderCurrentAttachments() {
    const group = document.getElementById('currentAttachGroup');
    const list = document.getElementById('currentAttachList');

    if (!editCurrentAttachments.length) {
      group.style.display = 'none';
      return;
    }
    group.style.display = 'block';
    list.innerHTML = '';

    editCurrentAttachments.forEach((att, idx) => {
      const item = document.createElement('div');
      item.className = 'current-attach-item';

      if (att.thumbUrl || (att.mimeType && att.mimeType.startsWith('image/'))) {
        const img = document.createElement('img');
        img.className = 'thumb-sm';
        img.src = att.thumbUrl || att.url;
        img.alt = att.fileName;
        img.onclick = () => openLightboxDrive(att);
        img.onerror = () => { img.style.display='none'; };
        item.appendChild(img);
      } else {
        const icon = document.createElement('div');
        icon.style.cssText = 'font-size:1.4rem;flex-shrink:0;';
        icon.textContent = getFileIcon(att.mimeType);
        item.appendChild(icon);
      }

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = att.fileName;
      item.appendChild(name);

      const viewBtn = document.createElement('a');
      viewBtn.href = att.viewUrl || att.url;
      viewBtn.target = '_blank';
      viewBtn.style.cssText = 'color:var(--blue);font-size:0.7rem;text-decoration:none;flex-shrink:0;';
      viewBtn.textContent = '‚Üó';
      item.appendChild(viewBtn);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn-detach';
      removeBtn.textContent = '‚úï';
      removeBtn.title = 'Remover este anexo';
      removeBtn.onclick = () => {
        editCurrentAttachments.splice(idx, 1);
        renderCurrentAttachments();
      };
      item.appendChild(removeBtn);

      list.appendChild(item);
    });
  }

  function closeEdit() {
    document.getElementById('editModal').classList.remove('active');
    editAttachments = [];
    editCurrentAttachments = [];
  }

  async function saveEdit() {
    const _row = document.getElementById('editRow').value;
    const nome = document.getElementById('editNome').value.trim();
    const idade = document.getElementById('editIdade').value.trim();
    if (!nome) { toast('Preencha o Nome!', 'error'); return; }
    if (!idade || isNaN(idade) || +idade < 0 || +idade > 150) { toast('Informe uma idade v√°lida!', 'error'); return; }

    const btn = document.getElementById('btnSaveEdit');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Enviando...';

    try {
      if (editAttachments.length > 0) {
        await uploadFiles(editAttachments, 'edit');
      }
      btn.innerHTML = '<span class="spinner"></span> Salvando...';

      const newUploaded = getUploadedAttachments(editAttachments);
      const allAttachments = [...editCurrentAttachments, ...newUploaded];

      const res = await fetch(API_URL, {
        method: 'POST', redirect: 'follow', credentials: 'omit',
        body: JSON.stringify({ action: 'update', _row: Number(_row), nome, idade: Number(idade), attachments: allAttachments })
      });
      const json = await res.json();
      if (json.ok) {
        toast('‚úì Registro atualizado!', 'success');
        closeEdit();
        await loadData();
      } else throw new Error();
    } catch { toast('Erro ao atualizar.', 'error'); }
    finally {
      btn.disabled = false;
      btn.innerHTML = '‚úì Salvar Altera√ß√µes';
    }
  }

  // ===== DELETE =====
  function openConfirm(row) {
    const r = allData.find(x => x._row == row);
    if (!r) return;
    pendingDeleteRow = row;
    document.getElementById('confirmMsg').textContent = 'Voc√™ est√° prestes a excluir o registro de ' + (r.Nome || '#' + r.ID) + '. Esta a√ß√£o n√£o pode ser desfeita.';
    document.getElementById('confirmModal').classList.add('active');
  }
  function closeConfirm() {
    document.getElementById('confirmModal').classList.remove('active');
    pendingDeleteRow = null;
  }
  async function confirmDelete() {
    if (!pendingDeleteRow) return;
    const btn = document.getElementById('btnConfirmDelete');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    try {
      const res = await fetch(API_URL, {
        method: 'POST', redirect: 'follow', credentials: 'omit',
        body: JSON.stringify({ action: 'delete', _row: Number(pendingDeleteRow) })
      });
      const json = await res.json();
      if (json.ok) {
        toast('‚úì Registro exclu√≠do!', 'success');
        closeConfirm();
        await loadData();
      } else throw new Error();
    } catch { toast('Erro ao excluir.', 'error'); }
    finally {
      btn.disabled = false;
      btn.innerHTML = '‚úï Excluir';
    }
  }

  // ===== LIGHTBOX =====
  function openLightboxLocal(dataUrl, name) {
    const content = document.getElementById('lightboxContent');
    content.innerHTML = `<img src="${dataUrl}" alt="${esc(name)}" />`;
    document.getElementById('lightboxCaption').textContent = name;
    document.getElementById('lightbox').classList.add('active');
  }

  function openLightboxDrive(att) {
    const content = document.getElementById('lightboxContent');
    document.getElementById('lightboxCaption').textContent = att.fileName;

    if (att.mimeType && att.mimeType.startsWith('image/')) {
      content.innerHTML = `<img src="${att.thumbUrl || att.url}" alt="${esc(att.fileName)}" style="max-width:80vw;max-height:75vh;border-radius:8px;object-fit:contain;" />`;
    } else if (att.mimeType === 'application/pdf') {
      content.innerHTML = `
        <div class="pdf-placeholder">
          <div class="icon">üìï</div>
          <p>${esc(att.fileName)}</p>
          <a href="${att.viewUrl || att.url}" target="_blank">‚Üó Abrir PDF no Drive</a>
        </div>`;
    } else {
      content.innerHTML = `
        <div class="pdf-placeholder">
          <div class="icon">${getFileIcon(att.mimeType)}</div>
          <p>${esc(att.fileName)}</p>
          <a href="${att.viewUrl || att.url}" target="_blank">‚Üó Abrir no Drive</a>
        </div>`;
    }
    document.getElementById('lightbox').classList.add('active');
  }

  function closeLightbox(e) {
    if (!e || e.target === document.getElementById('lightbox') || e.currentTarget.classList.contains('lightbox-close')) {
      document.getElementById('lightbox').classList.remove('active');
    }
  }

  // ===== RENDER =====
  function renderTable(data) {
    const area = document.getElementById('tableArea');
    if (!data || data.length === 0) {
      area.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><p>Nenhum registro encontrado</p></div>';
      return;
    }

    let rows = data.map(r => {
      let attachments = [];
      try {
        const raw = r.Anexos || r.attachments || '';
        attachments = raw ? JSON.parse(raw) : [];
      } catch {}

      const thumbsHtml = buildThumbsHtml(attachments, r._row);

      return `<tr>
        <td><span class="id-badge">#${esc(r.ID)}</span></td>
        <td>${esc(String(r.Nome ?? '‚Äî'))}</td>
        <td><span class="age-chip">${esc(String(r.Idade ?? '‚Äî'))} anos</span></td>
        <td>${thumbsHtml}</td>
        <td><div class="actions">
          <button class="btn-icon btn-edit" onclick="openEdit(${r._row})" title="Editar">‚úé</button>
          <button class="btn-icon btn-delete" onclick="openConfirm(${r._row})" title="Excluir">‚úï</button>
        </div></td>
      </tr>`;
    }).join('');

    area.innerHTML = '<div class="table-wrapper"><table><thead><tr><th>ID</th><th>Nome</th><th>Idade</th><th>Anexos</th><th>A√ß√µes</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
  }

  function buildThumbsHtml(attachments, rowId) {
    if (!attachments || !attachments.length) return '<span class="no-attach">‚Äî</span>';

    const MAX_SHOW = 3;
    let html = '<div class="thumb-row">';

    attachments.slice(0, MAX_SHOW).forEach((att, i) => {
      if (att.thumbUrl || (att.mimeType && att.mimeType.startsWith('image/'))) {
        html += `<img class="thumb-mini" src="${att.thumbUrl || att.url}" alt="${esc(att.fileName)}"
          title="${esc(att.fileName)}"
          onclick="openLightboxDriveByData('${btoa(JSON.stringify(att))}')"
          onerror="this.style.display='none'" />`;
      } else {
        const ext = att.fileName ? att.fileName.split('.').pop().toUpperCase() : '?';
        html += `<span class="file-chip" onclick="openLightboxDriveByData('${btoa(JSON.stringify(att))}')" title="${esc(att.fileName)}">${getFileIcon(att.mimeType)} ${ext}</span>`;
      }
    });

    if (attachments.length > MAX_SHOW) {
      html += `<span class="attach-count-badge">+${attachments.length - MAX_SHOW}</span>`;
    }

    html += '</div>';
    return html;
  }

  function openLightboxDriveByData(b64) {
    try {
      const att = JSON.parse(atob(b64));
      openLightboxDrive(att);
    } catch {}
  }

  function showLoading() {
    document.getElementById('tableArea').innerHTML = '<div class="loading"><div class="spinner"></div> Carregando...</div>';
  }
  function showError(msg) {
    document.getElementById('tableArea').innerHTML = '<div class="empty-state"><div class="icon">‚ö†</div><p>' + msg + '</p></div>';
  }

  function updateStats(data) {
    document.getElementById('statsRow').style.display = 'flex';
    document.getElementById('statTotal').textContent = data.length;
    const ages = data.map(r => Number(r.Idade)).filter(a => !isNaN(a) && a > 0);
    document.getElementById('statAvgAge').textContent = ages.length ? Math.round(ages.reduce((a,b)=>a+b,0)/ages.length) : '‚Äî';
    document.getElementById('statLast').textContent = data.length ? (data[data.length-1].ID ?? '‚Äî') : '‚Äî';

    // Count total attachments
    let totalAttach = 0;
    data.forEach(r => {
      try {
        const raw = r.Anexos || r.attachments || '';
        const arr = raw ? JSON.parse(raw) : [];
        totalAttach += arr.length;
      } catch {}
    });
    document.getElementById('statAttach').textContent = totalAttach;
  }

  function updateNextId(data) {
    const maxId = data.reduce((max, r) => Math.max(max, Number(r.ID) || 0), 0);
    document.getElementById('nextIdPreview').textContent = '#' + (maxId + 1) + ' (pr√≥ximo)';
  }

  function toast(msg, type) {
    const c = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = 'toast ' + (type || 'success');
    el.textContent = msg;
    c.appendChild(el);
    setTimeout(() => {
      el.style.cssText += 'opacity:0;transform:translateX(20px);transition:0.3s';
      setTimeout(() => el.remove(), 300);
    }, 3500);
  }

  function esc(str) {
    return String(str ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeEdit(); closeConfirm(); closeLightbox(); }
    if (e.key === 'Enter') {
      if (['inputNome','inputIdade'].includes(document.activeElement.id)) cadastrar();
      if (['editNome','editIdade'].includes(document.activeElement.id)) saveEdit();
    }
  });

  document.getElementById('editModal').addEventListener('click', e => {
    if (e.target === document.getElementById('editModal')) closeEdit();
  });
  document.getElementById('confirmModal').addEventListener('click', e => {
    if (e.target === document.getElementById('confirmModal')) closeConfirm();
  });
</script>
</body>
</html>
